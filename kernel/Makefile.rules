
unexport SUBDIRS
unexport O_TARGET
unexport O_OBJS
unexport PHONY

%.s: %.S
	$(CPP) $(CPPFLAGS) -D__ASSEMBLY__ -o $@ $<

# delete predefined rule
%.o: %.S

%.o: %.s
	$(AS) $(ASFLAGS) -o $@ $<

%.o: %.c
	$(CC) $(CPPFLAGS) $(CFLAGS) -c -o $@ $<

PHONY += first_rule
ifndef CLEAN_OBJS
first_rule: subdirs
	$(MAKE) all_targets
else
first_rule: subdirs
	$(MAKE) clean_targets
endif

PHONY += all_targets
all_targets: $(O_TARGET)
PHONY += clean_targets
clean_targets:
	$(RM) $(O_TARGET) $(O_OBJS) $(DEPS)

ifdef O_TARGET
ALL_O := $(O_OBJS)
$(O_TARGET): $(ALL_O)
	$(LD) $(LDFLAGS) -r -o $@ $(ALL_O)
endif

PHONY += subdirs
subdirs:
	set -e; for i in $(SUBDIRS); do $(MAKE) -C $$i; done

# dependencies generated by -MMD
DEPS := $(O_OBJS:%.o=%.d)
unexport DEPS

-include $(DEPS)

.PHONY: $(PHONY)
